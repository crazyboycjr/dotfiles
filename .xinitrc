#!/bin/sh

[[ -f ~/.Xresources ]] && xrdb -merge -I$HOME ~/.Xresources
[[ -f /etc/xprofile ]] && . /etc/xprofile
[[ -f ~/.xprofile ]] && . ~/.xprofile

# start mousemap
# /usr/local/bin/mousemap --daemonize
# now use mousemap.service

# set keyboard repeat <delay> <rate>
xset r rate 200 36
# disable screen saver blank screen
xset s noblank

# map control keys to caps lock
# setxkbmap -option "ctrl:nocaps"
# this setxkbmap setting may be somehow reset by mousemap
# now use the setting generated by localectl set-x11-keymap us "" "" ctrl:nocaps

# keymap
[[ -e /usr/bin/xmodmap && -f ~/.Xmodmap ]] && xmodmap ~/.Xmodmap

if [ -d /etc/X11/xinit/xinitrc.d ]; then
  for f in /etc/X11/xinit/xinitrc.d/*; do
    [ -x "$f" ] && . "$f"
  done
  unset f
fi

# set screenlayout to my dormitory setting
# gpu=`optimus-manager --print-mode | awk 'NF {print $NF}'` # this is not working
# location='external' # {dorm, lab, laptop, external}
# gpu='nvidia' # {nvidia, intel}
# source ~/.screenlayout/${location}-${gpu}.sh
# changed to use autorandr
# source .screenlayout/external-seattle-studio.sh
# autorandr --change philips # somehow autorandr --change does not work here
autorandr --change
# autorandr --change philips2
# autorandr --change mobile-nvidia

# mitigate the issue of screen not updating itself when using feh with xcompmgr
hsetroot -solid "#000066"
# start compositor
xcompmgr &

# set background
feh --bg-fill ~/.xmonad/background.jpg

# start authentication agent
/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &
# start gnome keyring
gnome-keyring-daemon --daemonize --login &
# /usr/lib/gnome-shell-calendar-server &
# gnome-calendar --gapplication-service &

# start clipboard manager
xfce4-clipman &

# start power manager
xfce4-power-manager &

# start screen saver
gnome-screensaver &

# startup programs
nm-applet &
blueman-applet &
dropbox &
optimus-manager-qt &
fcitx5 &
hp-systray --force-startup &

# here xmonad is kept as default
session=${1:-xmonad}
case $session in
    xmonad            ) exec xmonad;;
    i3|i3wm           ) exec i3;;
    kde               ) exec startplasma-x11;;
    xfce|xfce4        ) exec startxfce4;;
    # No known session, try to run it as command
    *                 ) exec $*;;
esac
